var Key=function(){var e={};e.SPACE=" ";var t=0;return document.addEventListener("keydown",function(e){t=e.keyCode}),document.addEventListener("keyup",function(){t=0}),e.down=function(e,t){document.addEventListener("keydown",function(n){n.keyCode==e.charCodeAt(0)&&t()})},e.up=function(){},e.isDown=function(e){var n=t==e.charCodeAt(0);return n},e}(),Menu=function(){for(var e,t,n,r=document.querySelector(".menu"),a=document.querySelector(".menu-button"),o=document.querySelector(".menu .close"),i=document.querySelectorAll(".effects li"),s=document.querySelector(".mic"),u=document.querySelector(".track"),c=function(e,t){e.style.webkitTransform="translateX("+t+"px)",e.style.msTransform="translateX("+t+"px)",e.style.MozTransform="translateX("+t+"px)",e.style.transform="translateX("+t+"px)"},l=0;l<i.length;l++){var d=i[l];d.addEventListener("click",function(t){for(var n=t.target,r=parseInt(n.getAttribute("data-index")),a=0;a<i.length;a++){var o=i[a];n==o?o.setAttribute("class","selected"):o.setAttribute("class",""),e&&e(r)}})}a.addEventListener("click",function(){a.style.opacity=0,r.style.opacity=1,c(r,0),setTimeout(function(){a.style.display="none"},200)}),o.addEventListener("click",function(){a.style.display="block",setTimeout(function(){a.style.opacity=1},1),r.style.opacity=0,c(r,-30)}),s.addEventListener("click",function(){s.setAttribute("class","selected"),u.setAttribute("class",""),t&&t()}),u.addEventListener("click",function(){s.setAttribute("class",""),u.setAttribute("class","selected"),n&&n()});var h={};return h.onEffect=function(t){e=t},h.onMic=function(e){t=e},h.onTrack=function(e){n=e},u.setAttribute("class","selected"),i[0].setAttribute("class","selected"),a.style.opacity=0,a.style.display="none",h}(),LeapWrapper=function(e){e=e||{};var t=this;this.ease=.15;var n=new SQR.V3(0,1,0),r=new SQR.V3,a=0,o=0;this.handOpen=0,this.isActive=!1,this.position=new SQR.V3,this.rotation=new SQR.V3,this.velocity=new SQR.V3;var i=!1,s=function(o){a=0;for(var s=o.fingers.length,u=0;s>u;u++){var c=o.fingers[0],l=c.direction;r.set(l[0],l[1],l[2]).norm(),a+=SQR.V3.dot(n,r)}a+=-1*(5-s),a/=5,t.frame=o,t.isActive=o.hands.length>0,t.hand=o.hands[0],t.isActive!=i&&e.toggleCallback&&e.toggleCallback(t.isActive),i=t.isActive};this.tick=function(){var e=this.ease;o+=(a-o)*e,this.handOpen=1+o,this.hand&&(this.position.x+=(this.hand.palmPosition[0]-this.position.x)*e,this.position.y+=(this.hand.palmPosition[1]-this.position.y)*e,this.position.z+=(this.hand.palmPosition[2]-this.position.z)*e,this.velocity.x+=(this.hand.palmVelocity[0]-this.velocity.x)*e,this.velocity.y+=(this.hand.palmVelocity[1]-this.velocity.y)*e,this.velocity.z+=(this.hand.palmVelocity[2]-this.velocity.z)*e,this.rotation.x+=(this.hand.pitch()-this.rotation.x)*e,this.rotation.y+=(this.hand.yaw()-this.rotation.y)*e,this.rotation.z+=(this.hand.roll()-this.rotation.z)*e)},Leap.loop(s)},SoundAnalyser=function(){var e={};e.levelsCount=8,e.waveCount=32,e.waveDataRaw=[],e.waveData=[],e.levelsData=[],e.level=0;var t,n,r,a,o,i,s,u,c=!1,l=!1,d=!1,h=0,f=0,m=15,v=.97,p=.25,g=1.05,S=function(){window.webkitAudioContext?t=new webkitAudioContext:window.AudioContext?t=new AudioContext:console.error("No Web Audio!"),r=t.createAnalyser(),r.smoothingTimeConstant=0,r.fftSize=1024,o=t.createGain(),volumeGainNode=t.createGain(),o.connect(t.destination),r.connect(o),volumeGainNode.connect(r),e.binCount=r.frequencyBinCount,e.waveBins=Math.floor(e.binCount/e.waveCount),e.levelBins=Math.floor(e.binCount/e.levelsCount),i=new Uint8Array(e.binCount),s=new Uint8Array(e.binCount)};return e.setVolume=function(e){o.gain.value=e},e.setSesitivity=function(e){volumeGainNode.gain.value=e},e.connectMic=function(){if(!l){if(c&&(source.disconnect(volumeGainNode),n.pause()),d)a.connect(volumeGainNode);else{if(navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,!navigator.getUserMedia)throw"No User Media detected";navigator.getUserMedia({audio:!0},function(e){a=t.createMediaStreamSource(e),a.connect(volumeGainNode),beatStart=(new Date).getTime()})}return l=!0,c=!1,d=!0,e}},e.connectTrack=function(e){c||(l&&a.disconnect(volumeGainNode),l=!1,c||(n=document.createElement("audio"),n.src=e,n.loop=!0,source=t.createMediaElementSource(n)),source.connect(volumeGainNode),n.play(),c=!0)},e.update=function(){r.getByteFrequencyData(i),r.getByteTimeDomainData(s);for(var t=0;t<e.binCount;t++)e.waveDataRaw[t]=(s[t]-128)/128;for(var t=0;t<e.waveCount;t++){for(var n=0,a=0;a<e.waveBins;a++)n+=e.waveDataRaw[t*e.waveBins+a];var o=n/e.waveBins;e.waveData[t]=o}for(var c=0,t=0;t<e.levelsCount;t++){for(var n=0,a=0;a<e.levelBins;a++)n+=i[t*e.levelBins+a];var o=n/e.levelBins/256;e.levelsData[t]=o,c+=o}e.level=c/e.levelsCount,f=e.level,f>h?(e.onBeat&&e.onBeat(),h=f*g,u=0):m>=u?u++:(h*=v,h=Math.max(h,p))},S(),e},SoundVisualizer=function(e,t,n){var r=e.width=t,a=e.height=n,o=1,i=0,s=e.getContext("2d"),u={},c=function(){s.clearRect(0,0,r,a)},l=function(e,t){s.strokeStyle="#fff",s.beginPath();for(var n=0;e>n;n++)s.lineTo(n/e*r,t[n]*a/2+a/2);s.stroke()},d=function(e,t){var n=r/e;s.fillStyle="rgba(255, 0, 0, 0.9)";for(var i=0;e>i;i++)s.fillRect(i*n,a,n-o,t[i]*-a)},h=function(e){var t=r/10;s.fillStyle="rgba("+i+", 100, "+i+", 1.0)",s.fillRect(r-t-o,a,t-o,e*-a),i=.8*i|0};return u.draw=function(e){c(),h(e.level),d(e.levelsCount,e.levelsData),l(e.waveCount,e.waveData)},u.onBeat=function(){i=255},u},VisualizerCollection=function(e){var t,n={};this.add=function(e,t){return n[e]=t,this},this.update=function(e,n,r){t.update(e,n,r)},this.onBeat=function(e){t.onBeat(e)},this.use=function(r,a,o){t&&(e.remove(t.object),t.dispose(a,o)),e.add(n[r].object),t=n[r],t.use(a,o)}},EffectCollection=function(){var e,t={};this.add=function(e,n){return t[e]=n,this},this.onBeat=function(){e.onBeat()},this.render=function(t,n,r,a){e.render(t,n,r,a)},this.use=function(n){e=t[n],e.use()}},Vignette=function(e){var t=new SQR.PostEffect("glsl/Vignette.glsl");this.use=function(){e.setClearColor(0,0,0,1)};var n=0,r=0;this.onBeat=function(){n=1},this.render=function(a,o,i,s){var u=s.isActive?.3:1;r+=.2*(n-r),n*=.8,t.renderer.u.uTime=SQR.Time.time,t.renderer.u.uBeat=r*u,t.setSource(a),e.render(t,null)}},Blur=function(e){var t=0,n=.05,r=e.createFrameBuffer(),a=e.createFrameBuffer(),o=e.createFrameBuffer(),i=(e.createFrameBuffer(),new SQR.PostEffect("glsl/Blur.glsl")),s=new SQR.PostEffect("glsl/PassThru.glsl"),u=e.createShader();u.load("glsl/Depth.glsl");var c=new SQR.PostEffect("glsl/DepthOfField.glsl");c.renderer.u.uBlurTexture=a.texture,c.renderer.u.uDepthTexture=o.texture,this.use=function(){e.setClearColor(0,0,0,1)},this.onBeat=function(){t=1},this.render=function(l,d,h){u.u.near=50+30*(1-t),u.u.far=60+50*(1-t),t*=.9,i.renderer.u.delta=[0,n],i.setSource(l),e.render(i,null,{target:r}),i.setSource(r),i.renderer.u.delta=[n,0],e.render(i,null,{target:a}),e.render(d,h,{target:o,replacementShader:u}),s.setSource(o),c.setSource(l),e.render(c,null)}},GlowChromaticDist=function(e){var t=0,n=.003,r=.015,a=1.5,o=0,i=0,s=e.createFrameBuffer(),u=e.createFrameBuffer(),c=new SQR.PostEffect("glsl/StrongBlur.glsl");c.renderer.u.uMult=a;var l=new SQR.PostEffect("glsl/GlowChroma.glsl");this.use=function(){e.setClearColor(0,0,0,1)},this.onBeat=function(){i=1},this.render=function(a){t+=n;var i=.5*Math.sin(t)+.5;i=Math.max(0,i),i=Math.min(1,i);var d=r*i;c.renderer.u.delta=[0,d],c.setSource(a),e.render(c,null,{target:s}),c.setSource(s),c.renderer.u.delta=[d,0],e.render(c,null,{target:u}),l.setSource(a),l.renderer.u.uBlurTexture=u.texture,e.render(l,null),l.renderer.u.uBeat=o}},ScanLines=function(e){var t=0,n=0;this.use=function(){e.setClearColor(.1,.2,.3,1)};var r=(e.createFrameBuffer(),e.createFrameBuffer(),e.createFrameBuffer()),a=(e.createFrameBuffer(),e.createShader());a.load("glsl/Depth.glsl"),a.u.far=100,a.u.near=60;var o=new SQR.PostEffect("glsl/ScanLines.glsl");o.renderer.u.uDepthTexture=r.texture;new SQR.RenderRegion(50,50,window.innerWidth/5,window.innerHeight/5);this.onBeat=function(){n=1},this.render=function(i,s,u){o.renderer.u.uTime=SQR.Time.time,o.renderer.u.uWidth=t,n*=.9,t+=.2*(n-t),e.render(s,u,{target:r,replacementShader:a}),o.setSource(i),e.render(o,null)}},NoEffect=function(e){this.use=function(){e.setClearColor(0,0,0,1)},this.onBeat=function(){},this.render=function(t,n,r){e.render(n,r)}},StrechingCube=function(e){var t=e.createShader();t.load("glsl/Normal2color.glsl");var n=0,r=0,a=0,o=new SQR.Transform;o.geometry=(new SQR.Cube).create(35,35,35),o.renderer=e.createRenderer(t),o.renderer.u.uColor=[0,.5,0,1],o.geometry.cornersOrig={},o.rotation.x=.25*Math.PI,o.rotation.y=.25*Math.PI;for(var i in o.geometry.corners)o.geometry.cornersOrig[i]=o.geometry.corners[i].clone(),o.geometry.corners[i].value=0,o.geometry.corners[i].speed=.001+.001*Math.random(),o.geometry.corners[i].phase=Math.PI*Math.random();this.use=function(){},this.dispose=function(){},this.onBeat=function(){0>a&&(a=1,n=o.rotation.x,r=o.rotation.y)},this.update=function(e){a>0&&(o.rotation.x=n+.5*Math.PI*SQR.Interpolation.smoothStep(0,1,1-a),o.rotation.y=r+.5*Math.PI*SQR.Interpolation.smoothStep(0,1,1-a)),a-=.04;var t=0;for(var i in o.geometry.corners){var s=o.geometry.corners[i],u=e.levelsData[t%e.levelsCount];s.value=Math.max(u,s.value),s.copyFrom(o.geometry.cornersOrig[i]),s.mul(1.4+.6*Math.sin(s.phase)),s.phase+=s.speed+s.value/3,s.value*=.92,t++}o.geometry.refresh()},this.object=o},LineSphere=function(e){var t=0,n=0,r=0,a=1,o=1,i=.85,s=.15,u=0,c=e.createShader();c.load("glsl/LineSphere.glsl");var l=new SQR.Transform;l.geometry=(new LineSphereGeometry).create(3e3,20,2),l.renderer=e.createRenderer(c),l.renderer.renderMode=SQR.GL.LINES,l.renderer.lineWidth=2,l.renderer.transparent=!0,this.onBeat=function(){n=-.3,r=.05},this.use=function(){},this.dispose=function(){};new SQR.V3,new SQR.V3(0,1,0);this.update=function(e,c,d){var h=d.isActive;o=d.isActive?d.handOpen:1;var f=r*Math.min(1,a);l.rotation.x+=.0023+.35*f,l.rotation.y+=.0027+.35*f,l.lookInDirection(null),l.geometry.refresh(e.levelsData,a),l.renderer.u.uTime=3*SQR.Time.time;var m=(1+t)*(.6+.4*Math.max(0,a));if(l.scale.set(m,m,m),t+=.1*(n-t),r*=.9,n*=.9,h)a+=.1*(o-a);else{var v=(a-o)*-s;u+=v,u*=i,a+=u}},this.object=l},SkyscraperLane=function(e){var t=0,n=.003,r=e.createShader();r.load("glsl/Skyscraper.glsl");var a=e.createShader();a.load("glsl/Horizon.glsl");var o=e.createShader();o.load("glsl/Traffic.glsl");var i=e.createShader();i.load("glsl/CityStreet.glsl");var s=300,u=0,c=0,l=0,d=0,h=0,f=0,m=[],v=new SQR.Transform;v.renderer=e.createRenderer(i),v.renderer.u.uColor=[0,0,0],v.geometry=new SQR.Cylinder({vertical:!1,perVertextNormals:!1,noCaps:!0}).create(200,s,200),v.position.set(0,-(s+30),50);for(var p=[],g=6,S=1;g>=S;S++){var w=new SQR.Transform;w.renderer=e.createRenderer(o),w.renderer.u.uNightColor=3>=S?[1,.75,.25]:[1,.25,0],w.renderer.u.uDayColor=3>=S?[.2,.2,.2]:[.2,.05,0],w.renderer.renderMode=SQR.GL.POINTS,w.geometry=(new Freeway).create(500,s+.1,.3),w.speed=3>=S?-0.0004*S:.002+.001*(3-Math.floor(S-3)),w.position.x=4*(S-3),v.add(w),p.push(w)}var y=new SQR.Transform;y.add(v);var R=new SQR.Transform;R.renderer=e.createRenderer(a),R.geometry=new SQR.Plane({zUp:!0,quads:!1}).create(6e3,2100),R.position.z=-1800,R.rotation.x=Math.PI;var Q=function(t,n){for(var a=t.clone(),o=0;n>o;o++){var i=new SQR.Transform;i.geometry=(new SQR.Cube).create(10+20*Math.random(),10+20*Math.random(),1,0,0,.5),i.renderer=e.createRenderer(r),i.buildingHeight=0,i.buildingBaseHeight=60+40*Math.random(),i.buildingHeightTarget=0,i.maxHeight=10+15*Math.random(),i.rotation.z=Math.random();var u=.3+.7*Math.random();i.renderer.u.uWindowColor=[.5+.5*u,.5,.1];var c=o/n*SQR.twoPI;m.push(i);var l=new SQR.Transform;l.lookInDirection(a),l.position.set(0,Math.sin(c)*s,Math.cos(c)*s).appendVec(t),v.add(l),l.add(i)}};Q(new SQR.V3(-35,0,0),50),Q(new SQR.V3(35,0,0),50),Q(new SQR.V3(-65,0,0),30),Q(new SQR.V3(65,0,0),30),this.use=function(e,t){t.ease=.1,e.add(R)},this.dispose=function(e){e.remove(R)},this.onBeat=function(){d=1,h=1,f=Math.random()>.5?-.8:.8};var M=0,T=0,b=0,V=0;document.addEventListener("mousemove",function(e){M=e.pageX/window.innerWidth*2-1,b=e.pageY/window.innerHeight}),this.update=function(e,r,a){t+=n;var o=.5*Math.sin(t)+.5;o=Math.max(0,o),o=Math.min(1,o),R.renderer.u.uDayTime=o,v.renderer.u.uDayTime=o;for(var i=0;i<m.length;i++){var s=m[i],S=e.levelsData[i%e.levelsCount]*s.maxHeight;s.buildingHeightTarget=S,s.buildingHeight+=.2*(s.buildingHeightTarget-s.buildingHeight);var w=s.buildingBaseHeight+20*s.buildingHeight;s.scale.set(1,1,w),s.renderer.u.uBuildingHeight=.33*w,s.renderer.u.uDayTime=o,s.renderer.u.uBeat=l,s.buildingHeightTarget*=.9}d*=.9,l+=.3*(d-l),h*=.975;var y=(Math.PI/8,.2*Math.sin(c));if(a.isActive){var Q=SQR.Mathx.clamp(a.position.x/4,-15,15),C=a.position.y-165,x=SQR.Mathx.clamp(C/2,-30,30),B=Q-r.position.x,D=x-r.position.y;r.position.x+=.2*B,r.position.y+=.2*D,r.rotation.z+=.2*(.1*B-r.rotation.z),r.rotation.x+=.2*(D*-.02-r.rotation.x)}else r.position.x*=.97,r.position.y*=.97,r.rotation.z*=.97,r.rotation.x*=.97+y;v.rotation.x-=a.isActive?.0025:.0015;for(var i=0;g>i;i++)p[i].rotation.x+=p[i].speed,p[i].renderer.u.uDayTime=o,p[i].renderer.u.uBeat=h;T+=.2*(M-T),V+=.2*(b-V),u+=.02,c+=f,f*=.95},this.object=y},SpaceRing=function(){var e="aParticleParam",t=new SQR.Geometry;t.attr(e,4);for(var n=3e4,r=[],a=0;n>a;a++)r.push(Math.random()*SQR.twoPI,.3*Math.random(),Math.random(),Math.random());return t.data(e,r),t},Gems=function(e){var t=new SQR.Transform,n=new SQR.Color,r=1,a=0,o=0,i=0,s=0,u=new SQR.Transform;t.add(u);var c="assets/skybox-blur/",l=e.createCubemap({left:c+"left.jpg",right:c+"right.jpg",up:c+"up.jpg",down:c+"down.jpg",back:c+"back.jpg",front:c+"front.jpg"}),d=e.createShader();d.load("glsl/DiscoBall.glsl");var h=e.createShader();h.load("glsl/SpaceRing.glsl");var f=new SQR.Transform;f.geometry=new SQR.Icosphere({perVertextNormals:!1}).create(90),f.geometry.subdivide(),f.geometry.subdivide(),f.renderer=e.createRenderer(d),f.renderer.u.uCubemap=l,t.position.set(0,0,-400),f.useQuaternion=!0,f.displace=function(e){var t=e;return function(e,n,r){for(var a=t.geometry.vectors,i=a.length,s=0;i>s;s++){var u=a[s];u.phase||(u.phase=Math.PI*Math.random()*2),u.max||(u.max=20),u.original||(u.original=u.clone()),u.normalized||(u.normalized=u.clone().norm()),u.beat||(u.beat=0);var c=(.5*Math.sin(u.phase)+.5)*u.max*(1+3*o);r&&(c*=.5),u.beat=Math.max(u.beat,e[[s%n]]),u.set().appendVec(u.normalized).mul(c).appendVec(u.original),u.phase+=.1+.1*o,u.beat*=.9}t.geometry.refresh()}}(f),t.add(f);var m=new SQR.Transform;m.geometry=new SpaceRing,m.renderer=e.createRenderer(h),m.renderer.renderMode=SQR.GL.POINTS,this.onBeat=function(){a=1,m.renderer.u.uBeat=SQR.Time.time},this.use=function(){},this.dispose=function(){};var v=new SQR.Quaternion,p=new SQR.V3(1,0,0),g=new SQR.V3(0,0,1),S=0,w=0,y=new SQR.V3;this.update=function(e,t,u){o+=.1*(a-o),a*=.9,s+=.1*(i-s),i*=.8,f.displace(e.levelsData,e.levelsCount,u.isActive),f.renderer.u.uEyePosition=t.position,f.renderer.u.uBeat=o,r+=.008,n.hsl(.5*Math.sin(r)+.5,1,.5).hslToRgb(),f.renderer.u.uColor=n,f.renderer.u.uTime=2*SQR.Time.time,m.renderer.u.uTime=SQR.Time.time,u.isActive?(i=1,y.copyFrom(u.velocity)):y.mul(.98),S=y.z/-5e3,w=y.x/5e3,v.fromAngleAxis(S,p.x,p.y,p.z),f.rotationQ.mul(v),v.fromAngleAxis(w,g.x,g.y,g.z),f.rotationQ.mul(v),m.renderer.u.uDamp=1-s,t.position.set(0,0,0)},this.object=t},Pyramids=function(e){var t=new SQR.Transform,n=Math.sqrt(2),r=e.createShader();r.load("glsl/PyramidAO.glsl");for(var a=[],o=4,i=20,s=13,u=Math.ceil(13/window.innerHeight*window.innerWidth),c=2*Math.sqrt(i*i/2),l=50,d=0,h=0,f=0,m=0,v=0,p=0,g=new Array(l),S=0;l>S;S++)g[S]=0;for(var w=function(n){var s=new SQR.Transform;return s.geometry=new SQR.Pyramid({noCap:!0}).create(i,0,0,o,0),s.renderer=e.createRenderer(r),s.renderer.u.uColor=n,t.add(s),a.push(s),s},y=new SQR.V2(.5,.5),R=0;u>R;R++)for(var Q=0;s>Q;Q++){var M=c*(u-1)/2,T=c*(s-1)/2,b=new SQR.V2(R/(u-1),Q/(s-1));b.sub(b,y);var V=2*b.mag()/n,C=1-V,x=(new SQR.Color).rgb(.2*C+.8,0,0),B=w(x);B.data={},B.data.centerDistance=Math.min(1,V),B.data.force=1-V,B.data.index=Math.floor(V*(l-1)),B.data.phase=0,B.data.speed=.1,B.data.distanceVector=b,B.data.handDistTarget=0,B.data.handDist=0,B.data.multTarget=0,B.data.mult=0,B.position.x=R*c-M,B.position.z=Q*c-T}this.onBeat=function(){f=1,m=0},this.use=function(){camera.position.z=0,camera.position.y=445,camera.rotation.x=SQR.halfPI},this.dispose=function(){};var D=new SQR.V2,z=new SQR.V2;this.update=function(t,r,o){if(o.isActive){p*=.9,h*=.9;var i=o.position.x/200,s=o.position.z/200;D.set(i,s)}else h+=.2*(f-h),v=t.level,p+=.02*(v-p),d+=.2*t.level,m+=.05;f*=.9,g.pop(),g.unshift(Math.sin(d)*(p+h+.1));for(var u=a.length,c=0;u>c;c++){var l=a[c],S=l.data;if(z.sub(D,S.distanceVector),o.isActive){var w=z.mag()/n;w=Math.pow(1-w,4),w*=1.4,S.handDistTarget=Math.max(w,S.handDistTarget)}S.handDistTarget*=.94,S.handDist+=.9*(S.handDistTarget-S.handDist);var y=Math.abs(g[S.index])+S.handDist,R=20+200*y*S.force;l.geometry.peak.y=R,l.geometry.refresh(),l.renderer.u.uHeight=R,l.renderer.u.uColor.blue(y)}e.render(root,r)},this.object=t},LineSphereGeometry=function(){var e,t,n,r=[],a=(new SQR.Geometry).quickSetup("v3n3t2"),o=this,i=[];return a.create=function(o,i,s){e=o,t=i,n=s;for(var u=0;e>u;u++){var c=(new SQR.V3).random().norm().mul(t),l=c.clone().norm().mul(n).appendVec(c);c.bump=0,c.anitDump=1-Math.pow(Math.random(),2),c.phase=Math.PI*Math.random(),r.push([c,l])}return a},a.refresh=function(t,s){i.length=0;for(var u=t.length,c=0;e>c;c++){var l=c%u,d=r[c][0];d.bump=Math.max(d.bump,t[l]),d.bump*=.95,d.phase+=.2;var h=20*(1+Math.sin(d.phase)),f=1+(n+h*d.bump)*s,m=d.clone().norm().mul(f).appendVec(d);r[c][1]=m}for(var c=0;e>c;c++){var v=r[c];i.push(v[0].x,v[0].y,v[0].z,v[1].x,v[1].y,v[1].z)}return a.data(SQR.Geometry.VERTEX,i),n+=d.bump/200,o.dirty=!0,a},a};SQR.Skyscraper=function(){e=e||{},e.offset=e.offset||new SQR.V3;var e,t=[],n=[],r=[],a=[],o=(new SQR.Geometry).quickSetup("v3n3t2");return o.create=function(e,n,r,a,i,s){t.length=0;var u=new SQR.V3(a||0,i||0,s||0),c=new SQR.V3(e*-.5,.5*n,.5*r).appendVec(u),l=new SQR.V3(.5*e,.5*n,.5*r).appendVec(u),d=new SQR.V3(e*-.5,n*-.5,.5*r).appendVec(u),h=new SQR.V3(.5*e,n*-.5,.5*r).appendVec(u),f=new SQR.V3(e*-.5,.5*n,r*-.5).appendVec(u),m=new SQR.V3(.5*e,.5*n,r*-.5).appendVec(u),v=new SQR.V3(e*-.5,n*-.5,r*-.5).appendVec(u),p=new SQR.V3(.5*e,n*-.5,r*-.5).appendVec(u),g=new SQR.V2(0,0),S=new SQR.V2(1,0),w=new SQR.V2(0,1),y=new SQR.V2(1,1);return t.push(new SQR.Triangle(c,l,h).setUV(w,y,S)),t.push(new SQR.Triangle(c,h,d).setUV(w,S,g)),t.push(new SQR.Triangle(f,p,m).setUV(y,g,w)),t.push(new SQR.Triangle(f,v,p).setUV(y,S,g)),t.push(new SQR.Triangle(c,d,f).setUV(y,S,w)),t.push(new SQR.Triangle(d,v,f).setUV(S,g,w)),t.push(new SQR.Triangle(l,m,h).setUV(w,y,g)),t.push(new SQR.Triangle(h,m,p).setUV(g,y,S)),t.push(new SQR.Triangle(c,f,l).setUV(g,w,S)),t.push(new SQR.Triangle(f,m,l).setUV(w,y,S)),t.push(new SQR.Triangle(d,h,v).setUV(w,y,g)),t.push(new SQR.Triangle(v,h,p).setUV(g,y,S)),o.refresh(),o},o.refresh=function(){var e=t.length;n.length=0,r.length=0,a.length=0;for(var i=0;e>i;i++)t[i].calculateNormal();for(var i=0;e>i;i++)t[i].toArray(n,r,a);return o.data(SQR.Geometry.VERTEX,n),o.data(SQR.Geometry.NORMAL,r),o.data(SQR.Geometry.TEXCOORD,a),o},o};var Freeway=function(){var e="aCarParam",t=[],n=[],r=(new SQR.Geometry).quickSetup("v3");r.attr(e,3);var a=.6;return r.create=function(e,o,i){for(var s=0;e>s;s++)if(!(Math.random()>i)){var u=s/e*SQR.twoPI,c=Math.sin(u)*o,l=Math.cos(u)*o;t.push(-a,l,c),t.push(+a,l,c);var d=new SQR.V3;d.x=Math.random(),d.y=Math.random(),d.z=Math.random(),n.push(d.x,d.y,d.z,d.x,d.y,d.z)}return r.refresh()},r.refresh=function(){return r.data(SQR.Geometry.VERTEX,t),r.data(e,n),r.dirty=!0,r},r},DEBUG=!1,USEMIC=!1,sound=new SoundAnalyser,volume,sensitivity,useMic=function(){volume=0,sensitivity=1,sound.setVolume(volume),sound.setSesitivity(sensitivity),sound.connectMic()},useTrack=function(){volume=1,sensitivity=1,sound.setVolume(volume),sound.setSesitivity(sensitivity),sound.connectTrack("assets/spy.mp3")};USEMIC?useMic():useTrack();var debugViz=new SoundVisualizer(document.querySelector("#viz-canvas"),128,64),root=new SQR.Transform,stats=new Stats;stats.domElement.setAttribute("class","stats"),DEBUG&&document.body.appendChild(stats.domElement);var engine=new SQR.SquarerootGL(document.getElementById("gl-canvas"));engine.setSize(window.innerWidth,window.innerHeight);var target=engine.createFrameBuffer(),projection=new SQR.ProjectionMatrix;projection.perspective(45,window.innerWidth/window.innerHeight,1,1e4),engine.setProjection(projection);var camera=new SQR.Transform;root.add(camera);var resetCamera=function(){camera.position.set(0,0,100),camera.rotation.set(0,0,0),camera.lookAt(null)};resetCamera();var nextTimeout,vizTTL=45e3,interactionIdleTTL=2e4,leap=new LeapWrapper,visualizer=new VisualizerCollection(root);visualizer.add("gems",new Gems(engine)),visualizer.add("linesphere",new LineSphere(engine)),visualizer.add("strechcube",new StrechingCube(engine)),visualizer.add("skyscraper",new SkyscraperLane(engine)),visualizer.add("pyramids",new Pyramids(engine));var effect=new EffectCollection;effect.add("vignette",new Vignette(engine)),effect.add("glow",new GlowChromaticDist(engine)),effect.add("scanlines",new ScanLines(engine)),effect.add("blur",new Blur(engine)),effect.add("none",new NoEffect(engine));var compositions=[["gems","vignette"],["skyscraper","glow"],["linesphere","blur"],["pyramids","none"],["strechcube","scanlines"]],setEffect=function(e){resetCamera(),visualizer.use(compositions[e][0],camera,leap),effect.use(compositions[e][1])};Menu.onEffect(setEffect),Menu.onMic(useMic),Menu.onTrack(useTrack),sound.onBeat=function(){DEBUG&&debugViz.onBeat(),visualizer.onBeat(camera),effect.onBeat()};var loop=function(){stats.begin(),requestAnimFrame(loop),SQR.Time.tick(),leap.tick(),sound.update(),DEBUG&&debugViz.draw(sound),visualizer.update(sound,camera,leap),engine.render(root,camera,{target:target}),effect.render(target,root,camera,leap),stats.end()};setEffect(0),loop();