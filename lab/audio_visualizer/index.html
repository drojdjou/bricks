<!DOCTYPE html>
<html>
<head>
    <title>basic audio playback brick</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable = no">
    <meta charset="utf-8">
    <style type="text/css">

    body {
    	font-family: monospace;
    	margin: 0;
    	padding: 0;
    	color: #0f0;
        background-color: #000000;
        font-size: 10pt;
    }

    * {
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
    }

    .start {
        padding: 10px;
        margin: 10px 10px 10px 10px;
        border: 1px dashed #0f0;
        display: block;
        text-align: center;
        background-color: #222222;
    }

    .bmp {
        margin: 10px;
        display: inline-block;
    }

    .start:hover, .start:active {
        color: #f00;
        background-color: #ddd;
        border: 1px dashed black;
        text-decoration: underline;
        cursor: pointer;
    }

    canvas {
        position: absolute;
        top: 0;
        left: 0;
        z-index: -100;
        background-color: #000000;
    }

    </style>

</head>
<body>

<canvas></canvas>

<div class="start">Start build 86</div>
<div class="bmp"></div>

<script type="text/javascript">

    var startBtn = document.querySelector('.start');
    var canvas = document.querySelector('canvas');
    var bmp = document.querySelector('.bmp');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    var context = canvas.getContext('2d');

    var soundFile = '../_assets/holdon.mp3';

    var audioContext = new (window.AudioContext || window.webkitAudioContext)();

    // var audioElement = document.createElement('audio');
    // var source = audioContext.createMediaElementSource(audioElement);

    var source = audioContext.createBufferSource();
    
    var analyzer = audioContext.createAnalyser();
    analyzer.fftSize = 1024;

    source.connect(analyzer);
    analyzer.connect(audioContext.destination);

    console.log('fft', analyzer.fftSize);
    console.log('fbc', analyzer.frequencyBinCount);
    console.log('max db', analyzer.maxDecibels);
    console.log('min db', analyzer.minDecibels);

    var floatFrequency = new Float32Array(analyzer.frequencyBinCount);
    var byteFrequency = new Uint8Array(analyzer.frequencyBinCount);
    // var floatFrequency = new Float32Array(analyzer.frequencyBinCount);

    var analyze = function() {
        console.log(arguments);
    }

    var start = function() {

        // audioElement.src = soundFile;
        // audioElement.play();

        request = new XMLHttpRequest();
        request.open('GET', soundFile, true);
        request.responseType = 'arraybuffer';

        request.onload = function() {
            var audioData = request.response;

            audioContext.decodeAudioData(audioData, function(buffer) {
                source.buffer = buffer;
                source.loop = true;
                source.start(0);
            }, function(e) {
                console.log("Error with decoding audio data" + e.err);
            });
        }

        request.send();

        startBtn.parentNode.removeChild(startBtn);
        run();
    }

    var levelHold = 0, beat = 0;

    var run = function() {
        requestAnimationFrame(run);

        var w = window.innerWidth;
        var h = window.innerHeight;

        var l = getLevel();
        var bc = (255 * beat) | 0;
        
        context.fillStyle = 'rgb(' + bc + ',' + bc + ',' + bc + ')';
        context.fillRect(0, 0, w, h);

        context.fillStyle = 'rgb(255,' + bc + ',' + bc + ')';
        context.strokeStyle = '#fff';
        context.lineWidth = 3;

        context.beginPath();
        context.arc(w/2, h/2, l, 0, Math.PI * 2);
        context.fill();

        levelHold = Math.max(levelHold, l);
        levelHold *= 0.995;

        context.beginPath();
        context.arc(w/2, h/2, levelHold, 0, Math.PI * 2);
        context.stroke();

        beat *= 0.9;
    }

    var beats = [];

    var levelHistory = [];

    var getLevel = function() {
        analyzer.getByteFrequencyData(byteFrequency);
        var s = 0;
        var fc = analyzer.frequencyBinCount;
        for(var i = 0; i < fc; i++) {
            var f = byteFrequency[i];
            f *= 1 + (i/fc)/2;
            s += f;
        }
        s = (s / fc) | 0;

        var limit = 5;
        if(s < levelHistory[0] && s > 0.15 && levelHistory.length > limit+1) {
            var m = 
                levelHistory[0] > levelHistory[limit-2] ||
                levelHistory[0] > levelHistory[limit-1] ||
                levelHistory[0] > levelHistory[limit-0];
            if(m) onBeat();
        }

        levelHistory.unshift(s);

        return s;
    }

    var onBeat = function() {
        var t = source.context.currentTime;
        if(beats.length == 0) {
            beats.push({ t: t, d: (t * 1000) | 0 });
        } else {
            var bd = ((t - beats[beats.length-1].t) | 0) * 1000;
            if(bd > 30) {
                beats.push({ t: t, d: bd });
            } else {
                return;
            }
        }

        beat = 1;

        var bl =  beats.length;
        var ab = 0;
        for(var i = 0; i < bl; i++) {
            ab += beats[i].d;
        }

        ab /= bl;
        ab = 60000 / ab;
        bmp.innerHTML = 'BMP: ' + (ab | 0);
    }

    // void getFloatFrequencyData (Float32Array array);
    // void getByteFrequencyData (Uint8Array array);
    // void getFloatTimeDomainData (Float32Array array);
    // void getByteTimeDomainData (Uint8Array array);
    // document.addEventListener('keydown', function(e) {

    //     if(e.keyCode == 'A'.charCodeAt(0)) {
    //         analyzer.getFloatFrequencyData(floatFrequency);
    //         console.log(floatFrequency);
    //     }

    //     // http://stackoverflow.com/questions/14169317/interpreting-web-audio-api-fft-results
    //     if(e.keyCode == 'Q'.charCodeAt(0)) {
    //         analyzer.getFloatFrequencyData(floatFrequency);
    //         var s = [];
    //         for(var i = 0; i < analyzer.frequencyBinCount; i++) {
    //             s.push((floatFrequency[i] - analyzer.minDecibels));// * (analyzer.maxDecibels - analyzer.minDecibels));
    //         }
    //         console.log(s);
    //     }

    //     if(e.keyCode == 'S'.charCodeAt(0)) {
    //         analyzer.getByteFrequencyData(byteFrequency);
    //         console.log(byteFrequency);
    //     }

    //     if(e.keyCode == 'W'.charCodeAt(0)) {
    //         getLevel();
    //     }
    // });

    startBtn.addEventListener('click', function(e) {
        start();
    });

</script>

<script>
if(location.host.indexOf('localhost') > -1 || location.host.indexOf('192.168') > -1) {
    document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] + ':35729/livereload.js?snipver=1"></' + 'script>');
}
</script>

</body>
</html>